<div class="level">
  <div class="level-left">
    <h1 class="title">Sprints</h1>
  </div>
</div>

<table class="table is-fullwidth is-striped">
  <thead>
    <tr><th>Nome</th><th>Status</th><th>Início</th><th>Entrega Prevista</th><th>Encerramento</th><% if (currentUser && currentUser.role==='Admin') { %><th>Ações</th><% } %></tr>
  </thead>
  <tbody>
    <% (sprints||[]).forEach(s => { %>
      <tr>
        <td><a href="/sprints/<%= s.id %>"><%= s.name %></a></td>
        <td><%= s.status %></td>
        <td><%= s.startedAt || '-' %></td>
        <td><%= s.dueDate || (s.status==='Created' ? 'Sprint ainda não iniciada' : '-') %></td>
        <td><%= s.closedAt || '-' %></td>
        <% if (currentUser && currentUser.role==='Admin') { %>
        <td>
          <form method="post" action="/sprints/<%= s.id %>/start" style="display:inline">
            <button class="button is-small is-link" <%= s.status!=='Created'?'disabled':'' %> type="submit">Iniciar</button>
          </form>
          <form method="post" action="/sprints/<%= s.id %>/close" style="display:inline">
            <button class="button is-small is-danger" <%= (s.status!=='Started' || (pendingBySprint && pendingBySprint[s.id]))?'disabled':'' %> type="submit" title="<%= (pendingBySprint && pendingBySprint[s.id]) ? 'Existem tarefas não concluídas' : '' %>">Encerrar</button>
          </form>
        </td>
        <% } %>
      </tr>
    <% }) %>
  </tbody>
</table>

<% if (currentUser && currentUser.role==='Admin') { %>
  <button id="new-sprint-btn" class="button is-primary" type="button" onclick="showCreateSprint()">Nova Sprint</button>
  <div id="create-sprint-box" style="display:none; margin-top: 1rem;">
    <h2 class="title is-5">Criar Sprint</h2>
    <form method="post" action="/sprints" class="box">
      <div class="field">
        <label class="label">Nome</label>
        <input class="input" name="name" required />
      </div>
      <div class="field">
        <label class="label">Tarefas <span class="has-text-grey is-size-6" style="font-weight: normal;">(Opcional)</span></label>
        <div class="select is-multiple is-fullwidth">
          <select multiple size="8" name="taskIds">
            <% (tasks||[]).forEach(t => { %>
              <option value="<%= t.id %>"><%= t.title %> - <%= t.status %></option>
            <% }) %>
          </select>
        </div>
        <p class="help">As tarefas podem ser adicionadas posteriormente ou durante a criação da sprint.</p>
      </div>
      <div class="field">
        <label class="label">Capacidade de QAs <span class="has-text-grey is-size-6" style="font-weight: normal;">(Opcional)</span></label>
        <p class="help">Informe a quantidade de QAs disponíveis por nível. TaskWise utilizará esses dados para calcular os dias e a data prevista da sprint com base em seus recursos atuais.</p>
        <div class="columns" style="margin-top: 0.5rem;">
          <div class="column is-4">
            <label class="label is-size-6">QAs Júnior</label>
            <input class="input" type="number" name="junior" step="1" min="0" placeholder="Quantidade">
          </div>
          <div class="column is-4">
            <label class="label is-size-6">QAs Pleno</label>
            <input class="input" type="number" name="pleno" step="1" min="0" placeholder="Quantidade">
          </div>
          <div class="column is-4">
            <label class="label is-size-6">QAs Sênior</label>
            <input class="input" type="number" name="senior" step="1" min="0" placeholder="Quantidade">
          </div>
        </div>
      </div>
      <div class="field">
        <button class="button is-primary" type="submit">Criar</button>
        <button class="button" type="button" onclick="cancelCreateSprint()">Cancelar</button>
      </div>
    </form>
  </div>
  <script>
    function showCreateSprint() {
      document.getElementById('create-sprint-box').style.display = 'block';
      const btn = document.getElementById('new-sprint-btn');
      btn.disabled = true;
      btn.title = 'A seção de criar sprint está aberta. Use o botão Cancelar para fechar.';
    }
    function cancelCreateSprint() {
      document.getElementById('create-sprint-box').style.display = 'none';
      const btn = document.getElementById('new-sprint-btn');
      btn.disabled = false;
      btn.title = '';
      // Limpar formulário ao cancelar
      const form = document.querySelector('#create-sprint-box form');
      if (form) form.reset();
    }
  </script>
<% } %>


